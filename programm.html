<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<link href="css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">

var KEY = '1NY3YC1AWC8xotzD2X0dMZuBSGS5ErjEtkYboGwKuZWc';
var GID_VERSION_TRACK = '14433307387';

function worksheet_url(gid) {
  return 'https://docs.google.com/spreadsheets/d/' + KEY + '/gviz/tq?gid=' + gid;
}

var track = new Array();
var num_tracks = -1, loaded_tracks = 0;

function append(nodename, innerhtml, parent) {
  var e = document.createElement(nodename);
  if (innerhtml)
    e.innerHTML = innerhtml;
  if (!parent)
    parent = document.getElementById('container');
  return parent.appendChild(e);
}

function status(str) {
  var s = document.getElementById('status');
  if (str)
    s.innerHTML = str;
  return s;
}

function errmsg(msg) {
  m = "Sorry, that didn't work. :\\ Please try reloading the page.";
  m += '<hr/>';
  m += '<span class="label label-danger">Details</span> ' + msg;
  status(m).setAttribute('class', 'alert alert-danger');
  return false;
}

function httpreq() {
  var noreq = 'Local error: XMLHTTP not available.';
  if (typeof(window.XMLHttpRequest) != 'undefined') {
    try {
      return new XMLHttpRequest();
    } catch(e) {
      return errmsg(noreq);
    }
  }

  if (window.ActiveXObject) {
    try {
      return new ActiveXObject("Msxml2.XMLHTTP");
    } catch(f) {
      try {
        return new ActiveXObject("Microsoft.XMLHTTP");
      } catch(g) {
        return errmsg(noreq);
      }
    }
  }

  return errmsg(noreq);
}

function httpget(url, func) {
  var req = httpreq();
  if (!req)
    return false;

  req.onreadystatechange = function() {
    if (req.readyState != req.DONE)
      return;
    if (req.status == 200)
      func(req, url);
    else
      errmsg('XHR ' + req.status + ' ' + req.statusText);
  }

  req.open('GET', url, true);
  req.send('');
  return true;
}

function table(req, name, gid) {
  name += ' (gid=' + gid + ')';

  var resp = req.responseText;
  if (!resp)
    return errmsg('No data available for ' + name + '.');

  resp = resp.replace(/^[^\(]*\(/, '').replace(/\);$/, '');
  resp = resp.replace(/"v":null/g, '"v":""');
  resp = resp.replace(/null/g, '{"v":""}');
  resp = resp.replace(/new Date\([^\)]*\)/g, '""');

  try {
    var ws = JSON.parse(resp + '');
  } catch(e) {
    return errmsg('Can not parse ' + name + ' response.<br/>' + e);
  }

  if (ws.version != '0.6')
    return errmsg('Unknown ' + name + ' internal worksheet version ' + ws.version + ', version 0.6 is needed.');
  if (ws.status != 'ok')
    return errmsg("Incorrect " + name + " internal worksheet status '" + ws.status + "', 'ok' is needed.");
  if (!ws.table)
    return errmsg('No information table exists in the ' + name + ' worksheet.');

  return ws.table;
}

function track_done(ret) {
  if (num_tracks == -1)
    return ret;

  ++loaded_tracks;

  var loaded = loaded_tracks.toString();
  var tracks = ' track' + (1 == num_tracks ? '' : 's') + '.';

  if (loaded_tracks < num_tracks) {
    loaded += ' of ' + num_tracks;
    tracks += '..'
  }

  var s = status();
  if (s.getAttribute('class') != 'alert alert-danger') {
    status('Loaded ' + loaded + tracks);
    if (loaded_tracks == num_tracks) {
      s.setAttribute('class', 'alert alert-success');
      setTimeout("status('').setAttribute('style', 'display:none')", 500);
    }
  }

  return ret;
}

function get_track(name, gid, pos) {
  httpget(worksheet_url(gid), function(req) {
    var t = table(req, name, gid);
    if (!t)
      return track_done(t);

    var i, c, time;
    var title, abstract, speaker, org;
    var html;

    for (i = 0; i < t.rows.length; i++) {
      time = t.rows[i].c[1].v[0].toString() + ':' +
        (t.rows[i].c[1].v[1] < 10 ? '0' : '') + t.rows[i].c[1].v[1].toString();

      title = t.rows[i].c[18].v;
      abstract = t.rows[i].c[20].v;
      speaker = t.rows[i].c[3].v + ' ' + t.rows[i].c[4].v;
      org = t.rows[i].c[5].v;

      html = '<span class="label label-primary">' + time + '</span> ';
      html += title;
      if (speaker != ' ' || org) {
        html += ' - ';
        if (speaker) {
          html += speaker;
          if (org)
            html += ', ';
        }
        if (org)
          html += org;
      }

      append('li', html, track[pos]).setAttribute('class', 'list-group-item');
    }

    return track_done();
  });
}

function get_versions(req) {
  var i, e, name = 'Versions', track_name = -1, gid = -1, col;
  var t = table(req, name, GID_VERSION_TRACK);

  if (!t)
    return track_done(t);

  for (i = 0; i < t.cols.length; i++)
    switch (t.cols[i].label) {
    case 'Track':
      track_name = i;
      break;
    case 'GID':
      gid = i;
      break;
    }

  if (-1 == track_name || -1 == gid) {
    if (-1 == track_name && -1 == gid)
      col = 'Track and no column named GID';
    else if (-1 == track_name)
      col = 'Track';
    else
      col = 'GID';

    track_done();
    return errmsg('Worksheet ' + name + ' has no column named ' + col + '.');
  }

  num_tracks = t.rows.length;
  status('Loaded 0 of ' + num_tracks + ' track' + (num_tracks != 1 ? 's' : '') + '...');

  for (i = 0; i < num_tracks; i++) {
    track[i] = append('ul');
    track[i].setAttribute('class', 'list-group');
    append('h3', t.rows[i].c[track_name].v, track[i]);
    get_track(t.rows[i].c[track_name].v, t.rows[i].c[gid].v, i);
  }
}

function go() {
  status('Loading...');
  httpget(worksheet_url(GID_VERSION_TRACK), get_versions);
}
</script>
</head>
<body onload="go()">
<div class="container" id="container">
<div class="jumbotron" style="text-align:center">
<h2>OpenTechSummit 2015</h2>
<p>Thursday, May 14<br/>Kalkscheune, Johannisstrasse 2, 10117 Berlin</p>
</div>
<div id="status" class="alert alert-info">
<noscript>Please enable JavaScript to view the program.</noscript>
</div>
</div>
</body>
</html>
